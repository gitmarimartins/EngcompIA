<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade Interativa - EngCompIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { primary: '#4F46E5', secondary: '#8B5CF6', surface: '#F9FAFB' }
                }
            },
            safelist: [
                'bg-red-50', 'text-red-700', 'border-red-100', 'bg-blue-50', 'text-blue-700', 'border-blue-100',
                'bg-green-50', 'text-green-700', 'border-green-100', 'bg-purple-50', 'text-purple-700', 'border-purple-100',
                'bg-indigo-50', 'text-indigo-700', 'border-indigo-100', 'bg-orange-50', 'text-orange-700', 'border-orange-100',
                'bg-pink-50', 'text-pink-700', 'border-pink-100', 'bg-teal-50', 'text-teal-700', 'border-teal-100'
            ]
        }
    </script>
    <style>[x-cloak] { display: none !important; } body { background-color: #F3F4F6; } .glass-header { background: #ffffff; border-bottom: 1px solid #E5E7EB; }</style>
</head>

<body class="text-gray-600 font-sans min-h-screen flex flex-col" 
      x-data="gradeApp()" 
      x-init="initApp()">

    <script>
        window.gradeRaw = [
            {% for t in grade %}
            {
                id: "{{ t.codigo }}_{{ t.turma }}",
                nome: "{{ t.nome }}",
                professor: "{{ t.professor }}",
                turma: "{{ t.turma }}",
                codigo: "{{ t.codigo }}",
                eh_equivalente: {{ 'true' if t.eh_equivalente else 'false' }},
                nome_original: "{{ t.nome_original }}",
                nome_curso_origem: "{{ t.nome_curso_origem }}",
                horarios: [
                    {% for h in t.horarios %}
                    { dia: "{{ h.dia }}", inicio: "{{ h.inicio }}", fim: "{{ h.fim }}" },
                    {% endfor %}
                ]
            },
            {% endfor %}
        ];
    </script>

    <nav class="glass-header sticky top-0 z-30 shadow-sm backdrop-blur-md bg-white/90">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-primary/10 p-2 rounded-lg text-primary"><i class="fa-solid fa-graduation-cap text-xl"></i></div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900 leading-tight">Grade Sugerida</h1>
                    <p class="text-xs text-gray-500 font-medium">2025/2 • Eng. Computação</p>
                </div>
            </div>
            <a href="/" class="group flex items-center gap-2 text-sm font-medium text-gray-500 hover:text-primary transition-colors px-3 py-2 rounded-lg hover:bg-gray-50">
                <i class="fa-solid fa-arrow-left transition-transform group-hover:-translate-x-1"></i>
                <span class="hidden sm:inline">Nova Simulação</span>
            </a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-1 w-full">
        
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div>
                <h2 class="text-2xl font-bold text-gray-900">Personalize sua Grade</h2>
                <p class="text-sm text-gray-500 mt-1">
                    <span x-show="hiddenIds.length === 0">Visualizando todas as sugestões.</span>
                    <span x-show="hiddenIds.length > 0" class="text-red-500 font-medium" x-text="hiddenIds.length + ' matéria(s) removida(s).'"></span>
                </p>
            </div>
            <div class="bg-white p-1 rounded-xl shadow-sm border border-gray-100 inline-flex overflow-x-auto max-w-full">
                <button @click="tab = 'lista'" :class="tab === 'lista' ? 'bg-primary text-white shadow-sm' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-list-ul"></i> Lista</button>
                <button @click="tab = 'visual'" :class="tab === 'visual' ? 'bg-primary text-white shadow-sm' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap"><i class="fa-regular fa-calendar-days"></i> Grade Visual</button>
                <button @click="tab = 'professores'" :class="tab === 'professores' ? 'bg-primary text-white shadow-sm' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-chalkboard-user"></i> Professores</button>
                <button @click="tab = 'ignoradas'" :class="tab === 'ignoradas' ? 'bg-red-50 text-red-600 border-red-100' : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'" class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 flex items-center gap-2 whitespace-nowrap"><i class="fa-solid fa-trash-can"></i> Lixeira <span x-show="hiddenIds.length > 0" class="ml-1 bg-red-100 text-red-600 text-[10px] px-1.5 rounded-full" x-text="hiddenIds.length"></span></button>
            </div>
        </div>

        <div x-show="tab === 'lista'" x-transition.opacity.duration.300ms class="space-y-4">
            
            <div class="flex justify-end gap-4 text-xs font-medium text-gray-500 mb-2">
                <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-primary"></span> Matriz Padrão</div>
                <div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-secondary"></span> Equivalência</div>
            </div>

            <div class="grid gap-4">
                {% for turma in grade %}
                {% set unique_id = turma.codigo ~ '_' ~ turma.turma %}
                <div x-show="isVisible('{{ unique_id }}')" class="bg-white rounded-xl p-5 shadow-sm hover:shadow-md transition-all duration-300 border border-transparent hover:border-primary/20 group relative overflow-hidden">
                    
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 {% if turma.eh_equivalente %} bg-secondary {% else %} bg-primary {% endif %}"></div>

                    <div class="flex flex-col lg:flex-row gap-6 items-start">
                        <div class="flex-1 min-w-0 ml-3">
                            <div class="flex items-center justify-between mb-1">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-lg font-bold text-gray-900 truncate group-hover:text-primary transition-colors">{{ turma.nome }}</h3>
                                    
                                    {% if turma.eh_equivalente %}
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-purple-100 text-purple-700 border border-purple-200">
                                            Equivalência
                                        </span>
                                    {% endif %}
                                </div>
                                
                                <button @click="toggleMateria('{{ unique_id }}')" class="text-gray-300 hover:text-red-500 transition p-2 hover:bg-red-50 rounded-lg"><i class="fa-solid fa-trash"></i></button>
                            </div>

                            <div class="flex flex-wrap items-center gap-y-2 gap-x-4 text-sm text-gray-500 mt-2">
                                <div class="flex items-center gap-1.5"><i class="fa-solid fa-chalkboard-user text-gray-400"></i><span class="font-medium text-gray-700">{{ turma.professor }}</span></div>
                                <div class="hidden sm:block w-1 h-1 bg-gray-300 rounded-full"></div>
                                <div class="flex items-center gap-1.5 font-mono text-xs"><i class="fa-solid fa-barcode text-gray-400"></i><span>{{ turma.codigo }}</span></div>
                                <div class="hidden sm:block w-1 h-1 bg-gray-300 rounded-full"></div>
                                <div class="flex items-center gap-1.5"><i class="fa-solid fa-layer-group text-gray-400"></i><span>Turma {{ turma.turma }}</span></div>
                            </div>

                            {% if turma.eh_equivalente %}
                            <div class="mt-3 p-3 bg-purple-50 rounded-lg border border-purple-100 text-xs text-purple-800 flex items-start gap-2">
                                <i class="fa-solid fa-exchange-alt mt-0.5 text-purple-500"></i>
                                <div>
                                    <p class="font-bold">Substitui: {{ turma.nome_original }}</p>
                                    <p class="opacity-75">Ofertada no curso: {{ turma.nome_curso_origem }}</p>
                                </div>
                            </div>
                            {% endif %}

                            {% if turma.tags %}
                            <div class="mt-3 flex flex-wrap gap-2">
                                {% for tag in turma.tags %}
                                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide border bg-{{ tag.cor }}-50 text-{{ tag.cor }}-700 border-{{ tag.cor }}-100">
                                    <i class="fa-solid {{ tag.icone }}"></i> {{ tag.texto }}
                                </span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="w-full lg:w-auto flex flex-col gap-2">
                            {% for h in turma.horarios %}
                                <div class="flex items-center justify-between lg:justify-end gap-3 px-3 py-1.5 rounded-lg text-sm border bg-gray-50 border-gray-100">
                                    <span class="font-bold uppercase text-xs tracking-wider">{{ h.dia }}</span><span class="font-mono font-medium">{{ h.inicio }} - {{ h.fim }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div x-show="tab === 'visual'" x-cloak x-transition.opacity.duration.300ms>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <div class="min-w-[1000px] p-6">
                        <div class="grid grid-cols-6 gap-4 mb-4">
                            <div class="text-center py-2 text-xs font-bold text-gray-400 uppercase tracking-widest">Horário</div>
                            <div class="text-center py-2 bg-gray-50 rounded-lg text-sm font-bold text-gray-700">Segunda</div>
                            <div class="text-center py-2 bg-gray-50 rounded-lg text-sm font-bold text-gray-700">Terça</div>
                            <div class="text-center py-2 bg-gray-50 rounded-lg text-sm font-bold text-gray-700">Quarta</div>
                            <div class="text-center py-2 bg-gray-50 rounded-lg text-sm font-bold text-gray-700">Quinta</div>
                            <div class="text-center py-2 bg-gray-50 rounded-lg text-sm font-bold text-gray-700">Sexta</div>
                        </div>

                        {% set slots = ['07:30', '08:30', '09:30', '10:30', '11:30', '13:30', '14:30', '15:30', '16:30', '17:30', '19:00', '20:00', '21:00'] %}
                        <div class="space-y-3">
                            {% for slot in slots %}
                            <div class="grid grid-cols-6 gap-4 group">
                                <div class="flex items-center justify-center text-xs font-mono font-medium text-gray-400">{{ slot }}</div>
                                {% for dia_nome in ['SEG', 'TER', 'QUA', 'QUI', 'SEX'] %}
                                <div @click="abrirSlot('{{ dia_nome }}', '{{ slot }}')" 
                                     class="relative h-24 border border-gray-100 rounded-xl bg-gray-50/50 transition-all hover:bg-white hover:shadow-md cursor-pointer">
                                    {% for turma in grade %}
                                        {% set unique_id = turma.codigo ~ '_' ~ turma.turma %}
                                        {% for h in turma.horarios %}
                                            {% if h.dia == dia_nome and h.inicio == slot %}
                                                <div x-show="isVisible('{{ unique_id }}')" 
                                                     class="absolute inset-1 rounded-lg p-2 flex flex-col justify-between shadow-sm border-l-4 {% if turma.eh_equivalente %} bg-purple-50 text-purple-900 border-purple-400 {% else %} bg-indigo-50 text-indigo-900 border-indigo-500 {% endif %} hover:z-10 transition-transform duration-200">
                                                    <div class="text-[10px] font-bold leading-tight line-clamp-2">{{ turma.nome }}</div>
                                                    <div class="text-[9px] opacity-80 flex justify-between items-end">
                                                        <span>{{ turma.turma }}</span>
                                                        {% if turma.eh_equivalente %}<i class="fa-solid fa-exchange-alt"></i>{% endif %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            {% if slot == '11:30' %} <div class="flex items-center gap-4 py-2 opacity-50"><div class="w-full h-px bg-gray-200"></div><span class="text-[10px] font-bold uppercase text-gray-400">Almoço</span><div class="w-full h-px bg-gray-200"></div></div> {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div x-show="tab === 'professores'" x-transition>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for professor, turmas in grade|groupby('professor') %}
                <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-12 h-12 rounded-full bg-indigo-50 text-primary flex items-center justify-center font-bold text-xl">{{ professor[0] }}</div>
                        <div class="flex-1 min-w-0"><h4 class="font-bold text-gray-900 truncate">{{ professor }}</h4></div>
                        <button @click="abrirAvaliacao('{{ professor }}')" class="text-gray-400 hover:text-primary"><i class="fa-regular fa-thumbs-up fa-lg"></i></button>
                    </div>
                    <div class="min-h-[30px] flex flex-wrap gap-2">
                        <template x-for="tag in getTopTags('{{ professor }}')" :key="tag.texto">
                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-[10px] font-bold uppercase bg-blue-50 text-blue-700 border border-blue-100"><i class="fa-solid fa-tag"></i> <span x-text="tag.texto"></span> <span x-text="'(' + tag.votos + ')'" class="opacity-60"></span></span>
                        </template>
                        <span x-show="getTopTags('{{ professor }}').length === 0" class="text-xs text-gray-400 italic">Sem votos ainda.</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div x-show="tab === 'ignoradas'" x-cloak x-transition>
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2"><i class="fa-solid fa-trash-can text-red-500"></i> Matérias Removidas</h3>
                <div x-show="hiddenIds.length === 0" class="text-center py-12 text-gray-400">Sua lixeira está vazia.</div>
                <div class="grid gap-3">
                    {% for turma in grade %}
                    {% set unique_id = turma.codigo ~ '_' ~ turma.turma %}
                    <div x-show="!isVisible('{{ unique_id }}')" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div><h4 class="font-bold text-gray-700">{{ turma.nome }}</h4><p class="text-xs text-gray-500">Prof. {{ turma.professor }}</p></div>
                        <button @click="toggleMateria('{{ unique_id }}')" class="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-green-200"><i class="fa-solid fa-rotate-left"></i> Restaurar</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </main>

    <div x-show="slotModalOpen" class="fixed inset-0 z-50 overflow-y-auto" aria-labelledby="slot-title" role="dialog" aria-modal="true" x-cloak>
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="slotModalOpen" x-transition.opacity class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity" @click="slotModalOpen = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="slotModalOpen" x-transition.scale class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <h3 class="text-lg leading-6 font-bold text-gray-900 mb-4" id="slot-title">
                        Matérias em <span x-text="slotDia + ' às ' + slotHora" class="text-primary"></span>
                    </h3>
                    <div class="space-y-3">
                        <template x-for="materia in slotMaterias" :key="materia.id">
                            <div class="p-3 rounded-lg border flex flex-col gap-2" :class="materia.eh_equivalente ? 'bg-purple-50 border-purple-100' : 'bg-gray-50 border-gray-200'">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-bold text-gray-800 text-sm" x-text="materia.nome"></div>
                                        <div class="text-xs text-gray-500">Prof. <span x-text="materia.professor"></span> • Turma <span x-text="materia.turma"></span></div>
                                    </div>
                                    <button @click="toggleMateria(materia.id); slotModalOpen=false" class="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded-full" title="Remover"><i class="fa-solid fa-trash"></i></button>
                                </div>
                                <div x-show="materia.eh_equivalente" class="text-xs text-purple-700 bg-purple-100 px-2 py-1 rounded">
                                    <strong>Substitui:</strong> <span x-text="materia.nome_original"></span> <br>
                                    <span class="opacity-75">Origem: <span x-text="materia.nome_curso_origem"></span></span>
                                </div>
                            </div>
                        </template>
                        <div x-show="slotMaterias.length === 0" class="text-center text-gray-400 py-4">Nenhuma matéria visível neste horário.</div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 flex justify-end">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:w-auto sm:text-sm" @click="slotModalOpen = false">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <div x-show="modalOpen" class="fixed inset-0 z-50 overflow-y-auto" role="dialog" aria-modal="true" x-cloak>
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div x-show="modalOpen" x-transition.opacity class="fixed inset-0 bg-gray-900 bg-opacity-50 transition-opacity" @click="modalOpen = false"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen">&#8203;</span>
            <div x-show="modalOpen" x-transition.scale class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10"><i class="fa-solid fa-user-secret text-primary"></i></div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Avaliar <span x-text="profSelecionado" class="font-bold text-primary"></span></h3>
                            <div class="mt-4 grid grid-cols-2 gap-3">
                                <button @click="votar('Didático')" class="p-3 border rounded-xl hover:bg-green-50 hover:text-green-700 transition flex items-center gap-2 text-sm"><i class="fa-solid fa-chalkboard-user"></i> Didático</button>
                                <button @click="votar('Cobra Presença')" class="p-3 border rounded-xl hover:bg-red-50 hover:text-red-700 transition flex items-center gap-2 text-sm"><i class="fa-solid fa-user-check"></i> Cobra Presença</button>
                                <button @click="votar('Prova Difícil')" class="p-3 border rounded-xl hover:bg-purple-50 hover:text-purple-700 transition flex items-center gap-2 text-sm"><i class="fa-solid fa-brain"></i> Prova Difícil</button>
                                <button @click="votar('Gente Boa')" class="p-3 border rounded-xl hover:bg-yellow-50 hover:text-yellow-700 transition flex items-center gap-2 text-sm"><i class="fa-solid fa-face-smile"></i> Gente Boa</button>
                                <button @click="votar('Listas Valem Nota')" class="p-3 border rounded-xl hover:bg-blue-50 hover:text-blue-700 transition flex items-center gap-2 text-sm"><i class="fa-solid fa-list-check"></i> Listas Valem Nota</button>
                                <button @click="votar('Seminários')" class="p-3 border rounded-xl hover:bg-pink-50 hover:text-pink-700 transition flex items-center gap-2 text-sm"><i class="fa-solid fa-people-group"></i> Seminários</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function gradeApp() {
            return {
                tab: 'lista',
                modalOpen: false,
                slotModalOpen: false,
                profSelecionado: '',
                slotDia: '',
                slotHora: '',
                slotMaterias: [],
                votosLocais: {},
                hiddenIds: [],

                initApp() { this.carregarVotos(); },

                toggleMateria(id) {
                    if (this.hiddenIds.includes(id)) { this.hiddenIds = this.hiddenIds.filter(i => i !== id); } 
                    else { this.hiddenIds.push(id); }
                },
                isVisible(id) { return !this.hiddenIds.includes(id); },

                abrirSlot(dia, hora) {
                    const materiasNoSlot = window.gradeRaw.filter(t => {
                        const temHorario = t.horarios.some(h => h.dia === dia && h.inicio === hora);
                        return temHorario && !this.hiddenIds.includes(t.id);
                    });
                    if (materiasNoSlot.length > 0) {
                        this.slotDia = dia; this.slotHora = hora; this.slotMaterias = materiasNoSlot; this.slotModalOpen = true;
                    }
                },

                async carregarVotos() { try { const res = await fetch('/obter_tags'); this.votosLocais = await res.json(); } catch(e){} },
                abrirAvaliacao(nome) { this.profSelecionado = nome; this.modalOpen = true; },
                async votar(tag) { await fetch('/votar', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ professor: this.profSelecionado, tag: tag }) }); await this.carregarVotos(); this.modalOpen = false; alert('Voto Computado!'); },
                getTopTags(nome) { if (!this.votosLocais[nome]) return []; return Object.entries(this.votosLocais[nome]).sort(([,a],[,b]) => b-a).slice(0, 3).map(([k, v]) => ({ texto: k, votos: v })); }
            }
        }
    </script>

    <footer class="border-t border-gray-200 bg-white py-8 mt-auto"><div class="max-w-7xl mx-auto px-4 text-center"><p class="text-sm text-gray-400 font-medium">© 2026 EngCompIA • Feito com <i class="fa-solid fa-code text-primary/50 mx-1"></i> por <span class="text-gray-600">Marina Martins</span></p></div></footer>
</body>
</html>